name: Supabase Pull Drift (cloud → repo)

on:
  workflow_dispatch: {}        # run manually from the Actions tab
  schedule:
    - cron: "0 6 * * *"        # optional: daily at 06:00 UTC

jobs:
  pull-remote-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        # with:
        #   version: 1.155.4   # (optional) pin the CLI version

      - name: Ensure supabase/migrations exists
        run: |
          mkdir -p supabase/migrations
          echo "----- existing migrations -----"
          ls -la supabase/migrations || true

      - name: Generate drift migration from LIVE (via DB URL)
        id: diff
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          set -e
          ts=$(date -u +"%Y%m%d%H%M%S")
          out="supabase/migrations/${ts}_remote_drift.sql"

          echo "Diffing LIVE → $out"
          supabase db diff \
            --db-url "$SUPABASE_DB_URL" \
            --schema public \
            --schema storage \
            --schema auth \
            -f "$out" || true

          echo "----- migrations after diff -----"
          ls -la supabase/migrations || true

          if [ -s "$out" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "file=$out" >> "$GITHUB_OUTPUT"
            echo "----- first 50 lines of generated file -----"
            head -n 50 "$out" || true
          else
            rm -f "$out"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No drift detected (or empty diff)."
          fi

      - name: Open/Update PR with drift migration
        if: steps.diff.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "chore(db): sync remote schema drift"
          commit-message: "chore(db): add migration generated from remote schema drift"
          branch: chore/db-remote-drift
          base: main
          add-paths: |
            supabase/migrations/**
          body: |
            Generated by `supabase db diff --db-url …` from the live project.
            Schemas included: public, storage, auth.
            Review & merge to keep Git the source of truth.
